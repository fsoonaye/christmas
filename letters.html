<!-- PantryID: 90f9f475-1c45-4996-b608-2773456ab125 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Letters</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Courier New', Courier, monospace; max-width: 800px; margin: 0 auto; padding: 40px; background: #fff; }
        .letter-container { margin-bottom: 40px; }
        .letter { background: #f9f9f9; padding: 20px; margin-bottom: 20px; border-left: 4px solid #333; white-space: pre-wrap; }
        .timestamp { font-size: 0.8em; color: #888; display: block; margin-top: 10px; }
        
        textarea { width: 100%; height: 100px; padding: 10px; font-family: inherit; margin-bottom: 10px; }
        button { background: #333; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <h1>Letters</h1>
    <a href="search.html" style="margin-bottom: 20px; display:block;">‚Üê Back to Search</a>

    <div id="letters-list" class="letter-container">
        <p>Loading letters...</p>
    </div>

    <hr>
    <h3>Write a Reply</h3>
    <textarea id="new-letter" placeholder="Type your message here..."></textarea>
    <button id="submit-btn" onclick="postLetter()">Send Letter</button>

    <script>
        const PANTRY_ID = "90f9f475-1c45-4996-b608-2773456ab125"; 
        const BUCKET_NAME = "christmas-letters";
        const BASE_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BUCKET_NAME}`;

        // 1. Fetch Letters on Load
        async function fetchLetters() {
            const list = document.getElementById('letters-list');
            try {
                const response = await fetch(BASE_URL);
                if (!response.ok) throw new Error('No letters yet');
                
                const data = await response.json();
                const letters = data.letters || [];
                
                list.innerHTML = letters.map(l => `
                    <div class="letter">
                        ${l.text}
                        <span class="timestamp">${l.date}</span>
                    </div>
                `).join('');
            } catch (e) {
                // If bucket doesn't exist yet, we initialize it
                list.innerHTML = "<p>No letters yet. Be the first to write one!</p>";
            }
        }

        // 2. Post New Letter
        async function postLetter() {
            const input = document.getElementById('new-letter');
            const btn = document.getElementById('submit-btn');
            const text = input.value.trim();
            if (!text) return;

            btn.disabled = true;
            btn.innerText = "Posting...";

            try {
                // Get existing letters first (Pantry overwrites, so we must fetch-modify-save)
                let currentLetters = [];
                try {
                    const res = await fetch(BASE_URL);
                    const data = await res.json();
                    currentLetters = data.letters || [];
                } catch(e) {}

                // Add new letter
                currentLetters.push({
                    text: text,
                    date: new Date().toLocaleString()
                });

                // Save back to Pantry
                await fetch(BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ letters: currentLetters })
                });

                input.value = "";
                fetchLetters(); // Refresh list
            } catch (error) {
                alert("Failed to send letter. Try again.");
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerText = "Send Letter";
            }
        }

        // Initial Load
        fetchLetters();
    </script>
</body>
</html>